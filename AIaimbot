local success, err = pcall(function()
-- 自瞄+ESP多功能脚本（优化版，已移除Ragebot）
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local Teams = game:GetService("Teams")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- 检测注入器名称
local injectorName = "未知注入器"
pcall(function()
    if syn then injectorName = "Synapse X" end
    if getexecutorname then injectorName = getexecutorname() or "KRNL" end
    if identifyexecutor then injectorName = identifyexecutor() or "ScriptWare" end
end)

-- 自瞄变量
local AimbotEnabled = false
local IsHoldingMouse2 = false
local LockedTarget = nil
local FOV = 100
local PredictionEnabled = false
local PredictionPing = 0
local AimbotIgnoreTeam = true

-- ESP变量
local ESPEnabled = false
local BoxESPEnabled = true
local SkeletonESPEnabled = true
local NameESPEnabled = true
local ToolESPEnabled = true
local TeamColorESPEnabled = true

-- ESP颜色设置
local BoxColor = Color3.fromRGB(255, 50, 50)
local SkeletonColor = Color3.fromRGB(255, 255, 255)
local NameColor = Color3.fromRGB(255, 255, 255)
local ToolColor = Color3.fromRGB(255, 255, 0)

-- ESP缓存（避免闪烁）
local ESPCache = {
    Boxes = {},      -- [玩家] = {line1, line2, line3, line4}
    Skeletons = {},  -- [玩家] = {line1, line2, ...}
    Names = {},      -- [玩家] = Drawing Text
    Tools = {},      -- [玩家] = Drawing Text
}

-- UI动画变量
local isAnimating = false
local dragging = false
local dragStart, startPos

-- ============== 辅助函数 ==============

local function GetPlayerTeamColor(plr)
    if not plr then return Color3.fromRGB(255, 255, 255) end
    if plr.TeamColor then return plr.TeamColor.Color end
    if plr.Team and plr.Team.TeamColor then return plr.Team.TeamColor.Color end
    if plr.Team and plr.Team.Color then return plr.Team.Color end
    return Color3.fromRGB(255, 255, 255)
end

local function IsSameTeam(plr1, plr2)
    if not plr1 or not plr2 then return false end
    if plr1.TeamColor and plr2.TeamColor then return plr1.TeamColor == plr2.TeamColor end
    if plr1.Team and plr2.Team then return plr1.Team == plr2.Team end
    return false
end

-- ============== 创建UI ==============
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AimbotESPGUI"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = CoreGui

-- 主容器
local MainContainer = Instance.new("Frame")
MainContainer.Name = "MainContainer"
MainContainer.Size = UDim2.new(0, 600, 0, 600)  -- 高度从700减到600（移除了Ragebot页面）
MainContainer.Position = UDim2.new(0.5, -300, 0.5, -300)
MainContainer.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainContainer.BorderSizePixel = 0
MainContainer.Visible = true
MainContainer.Active = true
MainContainer.Draggable = true
MainContainer.Parent = ScreenGui

local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 8)
ContainerCorner.Parent = MainContainer

-- 标题栏
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainContainer

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Size = UDim2.new(1, -60, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "自瞄+ESP 控制面板"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextSize = 14
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Font = Enum.Font.GothamBold
TitleText.Parent = TitleBar

-- 最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
MinimizeButton.Position = UDim2.new(1, -35, 0, 0)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
MinimizeButton.BorderSizePixel = 0
MinimizeButton.Text = "×"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.TextSize = 18
MinimizeButton.Visible = true
MinimizeButton.Parent = TitleBar

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.CornerRadius = UDim.new(0, 6)
MinimizeCorner.Parent = MinimizeButton

-- 最小化后的悬浮窗
local MinimizedButton = Instance.new("TextButton")
MinimizedButton.Name = "MinimizedButton"
MinimizedButton.Size = UDim2.new(0, 50, 0, 50)
MinimizedButton.Position = UDim2.new(0, 10, 0, 10)
MinimizedButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
MinimizedButton.BorderSizePixel = 0
MinimizedButton.Text = "A+E"
MinimizedButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizedButton.TextSize = 16
MinimizedButton.Visible = false
MinimizedButton.Parent = ScreenGui

local MinimizedCorner = Instance.new("UICorner")
MinimizedCorner.CornerRadius = UDim.new(0, 25)
MinimizedCorner.Parent = MinimizedButton

-- 侧边栏
local Sidebar = Instance.new("Frame")
Sidebar.Name = "Sidebar"
Sidebar.Size = UDim2.new(0, 120, 1, -30)
Sidebar.Position = UDim2.new(0, 0, 0, 30)
Sidebar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
Sidebar.BorderSizePixel = 0
Sidebar.Parent = MainContainer

-- 导航按钮（移除了Ragebot）
local NavButtons = {"主页", "自瞄", "ESP", "设置"}
local NavContainer = Instance.new("Frame")
NavContainer.Name = "NavContainer"
NavContainer.Size = UDim2.new(1, 0, 1, 0)
NavContainer.Position = UDim2.new(0, 0, 0, 0)
NavContainer.BackgroundTransparency = 1
NavContainer.Parent = Sidebar

for i, name in ipairs(NavButtons) do
    local button = Instance.new("TextButton")
    button.Name = name .. "Button"
    button.Size = UDim2.new(1, -10, 0, 32)
    button.Position = UDim2.new(0, 5, 0, 10 + (i-1) * 37)
    button.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    button.BorderSizePixel = 0
    button.Text = name
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 12
    button.Font = Enum.Font.Gotham
    button.Parent = NavContainer
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
end

-- 主内容区域
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, -120, 1, -30)
ContentFrame.Position = UDim2.new(0, 120, 0, 30)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainContainer

-- ============== 主页 ==============
local HomePage = Instance.new("Frame")
HomePage.Name = "HomePage"
HomePage.Size = UDim2.new(1, 0, 1, 0)
HomePage.BackgroundTransparency = 1
HomePage.Visible = true
HomePage.Parent = ContentFrame

local UserInfo = Instance.new("Frame")
UserInfo.Size = UDim2.new(1, -20, 0, 80)
UserInfo.Position = UDim2.new(0, 10, 0, 10)
UserInfo.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
UserInfo.BorderSizePixel = 0
UserInfo.Parent = HomePage
Instance.new("UICorner", UserInfo).CornerRadius = UDim.new(0, 8)

local UserText = Instance.new("TextLabel")
UserText.Size = UDim2.new(1, -10, 1, -10)
UserText.Position = UDim2.new(0, 5, 0, 5)
UserText.BackgroundTransparency = 1
UserText.Text = "用户: " .. player.Name .. "\n注入器: " .. injectorName .. "\n状态: 自瞄OFF | ESP OFF"
UserText.TextColor3 = Color3.fromRGB(255, 255, 255)
UserText.TextSize = 14
UserText.TextXAlignment = Enum.TextXAlignment.Left
UserText.TextYAlignment = Enum.TextYAlignment.Top
UserText.Font = Enum.Font.Gotham
UserText.Parent = UserInfo

local StatusFrame = Instance.new("Frame")
StatusFrame.Size = UDim2.new(1, -20, 0, 100)
StatusFrame.Position = UDim2.new(0, 10, 0, 100)
StatusFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
StatusFrame.BorderSizePixel = 0
StatusFrame.Parent = HomePage
Instance.new("UICorner", StatusFrame).CornerRadius = UDim.new(0, 8)

local StatusText = Instance.new("TextLabel")
StatusText.Size = UDim2.new(1, -10, 1, -10)
StatusText.Position = UDim2.new(0, 5, 0, 5)
StatusText.BackgroundTransparency = 1
StatusText.Text = "自瞄锁定目标: 无\nFOV范围: 100\n队伍检查: 开启"
StatusText.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusText.TextSize = 14
StatusText.TextXAlignment = Enum.TextXAlignment.Left
StatusText.TextYAlignment = Enum.TextYAlignment.Top
StatusText.Font = Enum.Font.Gotham
StatusText.Parent = StatusFrame

-- ============== 自瞄页面 ==============
local AimbotPage = Instance.new("Frame")
AimbotPage.Name = "AimbotPage"
AimbotPage.Size = UDim2.new(1, 0, 1, 0)
AimbotPage.BackgroundTransparency = 1
AimbotPage.Visible = false
AimbotPage.Parent = ContentFrame

local AimbotToggleButton = Instance.new("TextButton")
AimbotToggleButton.Size = UDim2.new(0.8, 0, 0, 40)
AimbotToggleButton.Position = UDim2.new(0.1, 0, 0.05, 0)
AimbotToggleButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
AimbotToggleButton.BorderSizePixel = 0
AimbotToggleButton.Text = "开启自瞄"
AimbotToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
AimbotToggleButton.TextSize = 16
AimbotToggleButton.Font = Enum.Font.Gotham
AimbotToggleButton.Parent = AimbotPage
Instance.new("UICorner", AimbotToggleButton).CornerRadius = UDim.new(0, 6)

local TeamCheckButton = Instance.new("TextButton")
TeamCheckButton.Size = UDim2.new(0.8, 0, 0, 35)
TeamCheckButton.Position = UDim2.new(0.1, 0, 0.12, 0)
TeamCheckButton.BackgroundColor3 = Color3.fromRGB(60, 180, 80)
TeamCheckButton.BorderSizePixel = 0
TeamCheckButton.Text = "忽略队友: 开启"
TeamCheckButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TeamCheckButton.TextSize = 14
TeamCheckButton.Font = Enum.Font.Gotham
TeamCheckButton.Parent = AimbotPage
Instance.new("UICorner", TeamCheckButton).CornerRadius = UDim.new(0, 6)

local FOVLabel = Instance.new("TextLabel")
FOVLabel.Size = UDim2.new(0.8, 0, 0, 20)
FOVLabel.Position = UDim2.new(0.1, 0, 0.2, 0)
FOVLabel.BackgroundTransparency = 1
FOVLabel.Text = "FOV范围: 100"
FOVLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
FOVLabel.TextSize = 14
FOVLabel.TextXAlignment = Enum.TextXAlignment.Left
FOVLabel.Font = Enum.Font.Gotham
FOVLabel.Parent = AimbotPage

local FOVSlider = Instance.new("Frame")
FOVSlider.Size = UDim2.new(0.8, 0, 0, 15)
FOVSlider.Position = UDim2.new(0.1, 0, 0.25, 0)
FOVSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
FOVSlider.BorderSizePixel = 0
FOVSlider.Parent = AimbotPage
Instance.new("UICorner", FOVSlider).CornerRadius = UDim.new(0, 7)

local FOVSliderFill = Instance.new("Frame")
FOVSliderFill.Size = UDim2.new(0.33, 0, 1, 0)
FOVSliderFill.BackgroundColor3 = Color3.fromRGB(80, 160, 255)
FOVSliderFill.BorderSizePixel = 0
FOVSliderFill.Parent = FOVSlider
Instance.new("UICorner", FOVSliderFill).CornerRadius = UDim.new(0, 7)

local FOVSliderButton = Instance.new("TextButton")
FOVSliderButton.Size = UDim2.new(1, 0, 1, 0)
FOVSliderButton.BackgroundTransparency = 1
FOVSliderButton.Text = ""
FOVSliderButton.Parent = FOVSlider

local PredictionTitle = Instance.new("TextLabel")
PredictionTitle.Size = UDim2.new(0.8, 0, 0, 20)
PredictionTitle.Position = UDim2.new(0.1, 0, 0.3, 0)
PredictionTitle.BackgroundTransparency = 1
PredictionTitle.Text = "预测延迟"
PredictionTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
PredictionTitle.TextSize = 14
PredictionTitle.TextXAlignment = Enum.TextXAlignment.Left
PredictionTitle.Font = Enum.Font.GothamBold
PredictionTitle.Parent = AimbotPage

local PredictionContainer = Instance.new("Frame")
PredictionContainer.Size = UDim2.new(0.8, 0, 0, 35)
PredictionContainer.Position = UDim2.new(0.1, 0, 0.35, 0)
PredictionContainer.BackgroundTransparency = 1
PredictionContainer.Parent = AimbotPage

local function createPredictionButton(text, pos)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.3, -5, 1, 0)
    btn.Position = pos
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
    btn.BorderSizePixel = 0
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    btn.Font = Enum.Font.Gotham
    btn.Parent = PredictionContainer
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    return btn
end

local Prediction100Button = createPredictionButton("100ms OFF", UDim2.new(0, 0, 0, 0))
local Prediction150Button = createPredictionButton("150ms OFF", UDim2.new(0.35, 0, 0, 0))
local Prediction200Button = createPredictionButton("200ms OFF", UDim2.new(0.7, 0, 0, 0))

local AimbotStatusLabel = Instance.new("TextLabel")
AimbotStatusLabel.Size = UDim2.new(0.8, 0, 0, 30)
AimbotStatusLabel.Position = UDim2.new(0.1, 0, 0.45, 0)
AimbotStatusLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
AimbotStatusLabel.BorderSizePixel = 0
AimbotStatusLabel.Text = "自瞄状态: 关闭 | 锁定: 无"
AimbotStatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
AimbotStatusLabel.TextSize = 14
AimbotStatusLabel.Font = Enum.Font.Gotham
AimbotStatusLabel.Parent = AimbotPage
Instance.new("UICorner", AimbotStatusLabel).CornerRadius = UDim.new(0, 6)

-- ============== ESP页面 ==============
local ESPPage = Instance.new("Frame")
ESPPage.Name = "ESPPage"
ESPPage.Size = UDim2.new(1, 0, 1, 0)
ESPPage.BackgroundTransparency = 1
ESPPage.Visible = false
ESPPage.Parent = ContentFrame

local ESPToggleButton = Instance.new("TextButton")
ESPToggleButton.Size = UDim2.new(0.8, 0, 0, 40)
ESPToggleButton.Position = UDim2.new(0.1, 0, 0.05, 0)
ESPToggleButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
ESPToggleButton.BorderSizePixel = 0
ESPToggleButton.Text = "开启ESP"
ESPToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPToggleButton.TextSize = 16
ESPToggleButton.Font = Enum.Font.Gotham
ESPToggleButton.Parent = ESPPage
Instance.new("UICorner", ESPToggleButton).CornerRadius = UDim.new(0, 6)

local TeamColorButton = Instance.new("TextButton")
TeamColorButton.Size = UDim2.new(0.8, 0, 0, 35)
TeamColorButton.Position = UDim2.new(0.1, 0, 0.12, 0)
TeamColorButton.BackgroundColor3 = Color3.fromRGB(60, 180, 80)
TeamColorButton.BorderSizePixel = 0
TeamColorButton.Text = "队伍颜色: 开启"
TeamColorButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TeamColorButton.TextSize = 14
TeamColorButton.Font = Enum.Font.Gotham
TeamColorButton.Parent = ESPPage
Instance.new("UICorner", TeamColorButton).CornerRadius = UDim.new(0, 6)

local ESPOptionsContainer = Instance.new("Frame")
ESPOptionsContainer.Size = UDim2.new(0.8, 0, 0, 240)
ESPOptionsContainer.Position = UDim2.new(0.1, 0, 0.2, 0)
ESPOptionsContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
ESPOptionsContainer.BorderSizePixel = 0
ESPOptionsContainer.Parent = ESPPage
Instance.new("UICorner", ESPOptionsContainer).CornerRadius = UDim.new(0, 8)

local ESPOptionsTitle = Instance.new("TextLabel")
ESPOptionsTitle.Size = UDim2.new(1, -20, 0, 30)
ESPOptionsTitle.Position = UDim2.new(0, 10, 0, 5)
ESPOptionsTitle.BackgroundTransparency = 1
ESPOptionsTitle.Text = "ESP显示选项"
ESPOptionsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPOptionsTitle.TextSize = 16
ESPOptionsTitle.TextXAlignment = Enum.TextXAlignment.Left
ESPOptionsTitle.Font = Enum.Font.GothamBold
ESPOptionsTitle.Parent = ESPOptionsContainer

local function createESPOptionButton(name, pos, defaultColor)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.45, -5, 0, 30)
    btn.Position = pos
    btn.BackgroundColor3 = defaultColor or Color3.fromRGB(60, 180, 80)
    btn.BorderSizePixel = 0
    btn.Text = name
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    btn.Font = Enum.Font.Gotham
    btn.Parent = ESPOptionsContainer
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    return btn
end

local BoxESPButton = createESPOptionButton("玩家方框: ON", UDim2.new(0.05, 0, 0.15, 0))
local BoxColorButton = createESPOptionButton("方框颜色", UDim2.new(0.55, 0, 0.15, 0), BoxColor)
local SkeletonESPButton = createESPOptionButton("玩家骨骼: ON", UDim2.new(0.05, 0, 0.3, 0))
local SkeletonColorButton = createESPOptionButton("骨骼颜色", UDim2.new(0.55, 0, 0.3, 0), SkeletonColor)
local NameESPButton = createESPOptionButton("玩家名字: ON", UDim2.new(0.05, 0, 0.45, 0))
local NameColorButton = createESPOptionButton("名字颜色", UDim2.new(0.55, 0, 0.45, 0), NameColor)
local ToolESPButton = createESPOptionButton("手持物品: ON", UDim2.new(0.05, 0, 0.6, 0))
local ToolColorButton = createESPOptionButton("物品颜色", UDim2.new(0.55, 0, 0.6, 0), ToolColor)

local ESPStatusLabel = Instance.new("TextLabel")
ESPStatusLabel.Size = UDim2.new(0.8, 0, 0, 30)
ESPStatusLabel.Position = UDim2.new(0.1, 0, 0.7, 0)
ESPStatusLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
ESPStatusLabel.BorderSizePixel = 0
ESPStatusLabel.Text = "ESP状态: 关闭"
ESPStatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPStatusLabel.TextSize = 14
ESPStatusLabel.Font = Enum.Font.Gotham
ESPStatusLabel.Parent = ESPPage
Instance.new("UICorner", ESPStatusLabel).CornerRadius = UDim.new(0, 6)

-- ============== 设置页面 ==============
local SettingsPage = Instance.new("Frame")
SettingsPage.Name = "SettingsPage"
SettingsPage.Size = UDim2.new(1, 0, 1, 0)
SettingsPage.BackgroundTransparency = 1
SettingsPage.Visible = false
SettingsPage.Parent = ContentFrame

local SettingsTitle = Instance.new("TextLabel")
SettingsTitle.Size = UDim2.new(1, -20, 0, 30)
SettingsTitle.Position = UDim2.new(0, 10, 0, 10)
SettingsTitle.BackgroundTransparency = 1
SettingsTitle.Text = "设置"
SettingsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SettingsTitle.TextSize = 18
SettingsTitle.TextXAlignment = Enum.TextXAlignment.Left
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.Parent = SettingsPage

local ResetUIButton = Instance.new("TextButton")
ResetUIButton.Size = UDim2.new(0.8, 0, 0, 40)
ResetUIButton.Position = UDim2.new(0.1, 0, 0.15, 0)
ResetUIButton.BackgroundColor3 = Color3.fromRGB(80, 160, 255)
ResetUIButton.BorderSizePixel = 0
ResetUIButton.Text = "重置UI位置"
ResetUIButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ResetUIButton.TextSize = 14
ResetUIButton.Font = Enum.Font.Gotham
ResetUIButton.Parent = SettingsPage
Instance.new("UICorner", ResetUIButton).CornerRadius = UDim.new(0, 6)

local HideUIButton = Instance.new("TextButton")
HideUIButton.Size = UDim2.new(0.8, 0, 0, 40)
HideUIButton.Position = UDim2.new(0.1, 0, 0.25, 0)
HideUIButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
HideUIButton.BorderSizePixel = 0
HideUIButton.Text = "隐藏UI"
HideUIButton.TextColor3 = Color3.fromRGB(255, 255, 255)
HideUIButton.TextSize = 14
HideUIButton.Font = Enum.Font.Gotham
HideUIButton.Parent = SettingsPage
Instance.new("UICorner", HideUIButton).CornerRadius = UDim.new(0, 6)

local PerformanceLabel = Instance.new("TextLabel")
PerformanceLabel.Size = UDim2.new(0.8, 0, 0, 80)
PerformanceLabel.Position = UDim2.new(0.1, 0, 0.4, 0)
PerformanceLabel.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
PerformanceLabel.BorderSizePixel = 0
PerformanceLabel.Text = "性能优化已启用\nESP缓存机制 | 无闪烁\n队伍颜色: 根据排行榜自动变化"
PerformanceLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
PerformanceLabel.TextSize = 13
PerformanceLabel.Font = Enum.Font.Gotham
PerformanceLabel.Parent = SettingsPage
Instance.new("UICorner", PerformanceLabel).CornerRadius = UDim.new(0, 8)

-- ============== 功能连接 ==============

-- 页面切换
for _, button in ipairs(NavContainer:GetChildren()) do
    if button:IsA("TextButton") then
        button.MouseButton1Click:Connect(function()
            for _, child in ipairs(ContentFrame:GetChildren()) do
                if child:IsA("Frame") then child.Visible = false end
            end
            if button.Text == "主页" then HomePage.Visible = true
            elseif button.Text == "自瞄" then AimbotPage.Visible = true
            elseif button.Text == "ESP" then ESPPage.Visible = true
            elseif button.Text == "设置" then SettingsPage.Visible = true end
        end)
    end
end

-- 自瞄开关
local function ToggleAimbot()
    AimbotEnabled = not AimbotEnabled
    AimbotToggleButton.Text = AimbotEnabled and "关闭自瞄" or "开启自瞄"
    AimbotToggleButton.BackgroundColor3 = AimbotEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
    local status = AimbotEnabled and "ON" or "OFF"
    AimbotStatusLabel.Text = "自瞄状态: " .. status .. " | 锁定: " .. (LockedTarget and LockedTarget.Name or "无")
    UserText.Text = "用户: " .. player.Name .. "\n注入器: " .. injectorName .. "\n状态: 自瞄" .. status .. " | ESP " .. (ESPEnabled and "ON" or "OFF")
end
AimbotToggleButton.MouseButton1Click:Connect(ToggleAimbot)

-- 自瞄队伍检查
local function ToggleAimbotTeam()
    AimbotIgnoreTeam = not AimbotIgnoreTeam
    TeamCheckButton.Text = "忽略队友: " .. (AimbotIgnoreTeam and "开启" or "关闭")
    TeamCheckButton.BackgroundColor3 = AimbotIgnoreTeam and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
    StatusText.Text = "自瞄锁定目标: " .. (LockedTarget and LockedTarget.Name or "无") .. "\nFOV范围: " .. FOV .. "\n队伍检查: " .. (AimbotIgnoreTeam and "开启" or "关闭")
end
TeamCheckButton.MouseButton1Click:Connect(ToggleAimbotTeam)

-- 预测按钮
local function SetupPrediction(btn, ping)
    btn.MouseButton1Click:Connect(function()
        if PredictionPing == ping then PredictionEnabled = not PredictionEnabled
        else PredictionPing = ping; PredictionEnabled = true end
        Prediction100Button.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
        Prediction150Button.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
        Prediction200Button.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
        Prediction100Button.Text = "100ms OFF"
        Prediction150Button.Text = "150ms OFF"
        Prediction200Button.Text = "200ms OFF"
        if PredictionEnabled then
            btn.BackgroundColor3 = Color3.fromRGB(80, 160, 255)
            btn.Text = ping .. "ms ON"
        end
    end)
end
SetupPrediction(Prediction100Button, 100)
SetupPrediction(Prediction150Button, 150)
SetupPrediction(Prediction200Button, 200)

-- FOV滑块
FOVSliderButton.MouseButton1Down:Connect(function()
    local conn; conn = UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            local mouseX = UserInputService:GetMouseLocation().X
            local sliderX = FOVSlider.AbsolutePosition.X
            local size = FOVSlider.AbsoluteSize.X
            local x = math.clamp(mouseX - sliderX, 0, size)
            local ratio = x / size
            FOV = math.floor(ratio * 300)
            FOVSliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            FOVLabel.Text = "FOV范围: " .. FOV
            StatusText.Text = "自瞄锁定目标: " .. (LockedTarget and LockedTarget.Name or "无") .. "\nFOV范围: " .. FOV .. "\n队伍检查: " .. (AimbotIgnoreTeam and "开启" or "关闭")
        end
    end)
    local endConn; endConn = UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            conn:Disconnect(); endConn:Disconnect()
        end
    end)
end)

-- ESP开关
local function ToggleESP()
    ESPEnabled = not ESPEnabled
    ESPToggleButton.Text = ESPEnabled and "关闭ESP" or "开启ESP"
    ESPToggleButton.BackgroundColor3 = ESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
    UserText.Text = "用户: " .. player.Name .. "\n注入器: " .. injectorName .. "\n状态: 自瞄" .. (AimbotEnabled and "ON" or "OFF") .. " | ESP " .. (ESPEnabled and "ON" or "OFF")
    if not ESPEnabled then
        -- 隐藏所有ESP
        for _, lines in pairs(ESPCache.Boxes) do
            for _, line in ipairs(lines) do line.Visible = false end
        end
        for _, lines in pairs(ESPCache.Skeletons) do
            for _, line in ipairs(lines) do line.Visible = false end
        end
        for _, label in pairs(ESPCache.Names) do if label then label.Visible = false end end
        for _, label in pairs(ESPCache.Tools) do if label then label.Visible = false end end
    end
end
ESPToggleButton.MouseButton1Click:Connect(ToggleESP)

-- 队伍颜色ESP
local function ToggleTeamColor()
    TeamColorESPEnabled = not TeamColorESPEnabled
    TeamColorButton.Text = "队伍颜色: " .. (TeamColorESPEnabled and "开启" or "关闭")
    TeamColorButton.BackgroundColor3 = TeamColorESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
end
TeamColorButton.MouseButton1Click:Connect(ToggleTeamColor)

-- ESP子选项
BoxESPButton.MouseButton1Click:Connect(function()
    BoxESPEnabled = not BoxESPEnabled
    BoxESPButton.Text = "玩家方框: " .. (BoxESPEnabled and "ON" or "OFF")
    BoxESPButton.BackgroundColor3 = BoxESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
end)
SkeletonESPButton.MouseButton1Click:Connect(function()
    SkeletonESPEnabled = not SkeletonESPEnabled
    SkeletonESPButton.Text = "玩家骨骼: " .. (SkeletonESPEnabled and "ON" or "OFF")
    SkeletonESPButton.BackgroundColor3 = SkeletonESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
end)
NameESPButton.MouseButton1Click:Connect(function()
    NameESPEnabled = not NameESPEnabled
    NameESPButton.Text = "玩家名字: " .. (NameESPEnabled and "ON" or "OFF")
    NameESPButton.BackgroundColor3 = NameESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
end)
ToolESPButton.MouseButton1Click:Connect(function()
    ToolESPEnabled = not ToolESPEnabled
    ToolESPButton.Text = "手持物品: " .. (ToolESPEnabled and "ON" or "OFF")
    ToolESPButton.BackgroundColor3 = ToolESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(200, 60, 60)
end)

-- 颜色按钮（简单示例，实际可扩展颜色选择器）
BoxColorButton.MouseButton1Click:Connect(function()
    BoxColor = Color3.fromRGB(255, 255, 255)
    BoxColorButton.BackgroundColor3 = BoxColor
end)
SkeletonColorButton.MouseButton1Click:Connect(function()
    SkeletonColor = Color3.fromRGB(255, 255, 255)
    SkeletonColorButton.BackgroundColor3 = SkeletonColor
end)
NameColorButton.MouseButton1Click:Connect(function()
    NameColor = Color3.fromRGB(255, 255, 255)
    NameColorButton.BackgroundColor3 = NameColor
end)
ToolColorButton.MouseButton1Click:Connect(function()
    ToolColor = Color3.fromRGB(255, 255, 255)
    ToolColorButton.BackgroundColor3 = ToolColor
end)

-- 重置UI位置
local function ResetUIPosition()
    MainContainer.Position = UDim2.new(0.5, -300, 0.5, -300)
    MinimizedButton.Position = UDim2.new(0, 10, 0, 10)
end
ResetUIButton.MouseButton1Click:Connect(ResetUIPosition)

-- 隐藏UI
local function HideUI()
    ScreenGui.Enabled = false
end
HideUIButton.MouseButton1Click:Connect(HideUI)

-- 最小化动画
local function createOpenAnimation()
    if isAnimating then return end
    isAnimating = true
    MainContainer.Visible = true
    MinimizedButton.Visible = false
    local originalSize = UDim2.new(0, 600, 0, 600)
    local originalPos = UDim2.new(0.5, -300, 0.5, -300)
    local btnPos = MinimizedButton.AbsolutePosition
    local btnSize = MinimizedButton.AbsoluteSize
    MainContainer.Size = UDim2.new(0, btnSize.X, 0, btnSize.Y)
    MainContainer.Position = UDim2.new(0, btnPos.X, 0, btnPos.Y)
    TweenService:Create(MainContainer, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = originalSize}):Play()
    TweenService:Create(MainContainer, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Position = originalPos}):Play()
    task.wait(0.3); isAnimating = false
end
local function createCloseAnimation()
    if isAnimating then return end
    isAnimating = true
    local targetSize = MinimizedButton.Size
    local targetPos = MinimizedButton.Position
    TweenService:Create(MainContainer, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Size = targetSize}):Play()
    TweenService:Create(MainContainer, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Position = targetPos}):Play()
    task.wait(0.25)
    MainContainer.Visible = false
    MinimizedButton.Visible = true
    isAnimating = false
end
MinimizeButton.MouseButton1Click:Connect(createCloseAnimation)
MinimizedButton.MouseButton1Click:Connect(createOpenAnimation)

-- 悬浮窗拖动
MinimizedButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MinimizedButton.Position
    end
end)
MinimizedButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        local newX = math.clamp(startPos.X.Offset + delta.X, 0, ScreenGui.AbsoluteSize.X - MinimizedButton.AbsoluteSize.X)
        local newY = math.clamp(startPos.Y.Offset + delta.Y, 0, ScreenGui.AbsoluteSize.Y - MinimizedButton.AbsoluteSize.Y)
        MinimizedButton.Position = UDim2.new(0, newX, 0, newY)
    end
end)

-- ============== 自瞄核心 ==============

UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 and AimbotEnabled then
        IsHoldingMouse2 = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        IsHoldingMouse2 = false
        LockedTarget = nil
        AimbotStatusLabel.Text = "自瞄状态: " .. (AimbotEnabled and "ON" or "OFF") .. " | 锁定: 无"
    end
end)

local function GetClosestPlayer()
    local closest, dist = nil, FOV
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
            if AimbotIgnoreTeam and IsSameTeam(player, p) then continue end
            local hum = p.Character:FindFirstChildOfClass("Humanoid")
            if not hum or hum.Health <= 0 then continue end
            local screen = camera:WorldToViewportPoint(p.Character.Head.Position)
            if screen.Z > 0 then
                local mouse = UserInputService:GetMouseLocation()
                local d = (Vector2.new(mouse.X, mouse.Y) - Vector2.new(screen.X, screen.Y)).Magnitude
                if d < dist then closest, dist = p, d end
            end
        end
    end
    return closest
end

-- FOV圆圈
local Circle = Drawing.new("Circle")
Circle.Color = Color3.fromRGB(0, 255, 0)
Circle.Thickness = 2
Circle.Filled = false
Circle.NumSides = 64
Circle.Transparency = 0.7
Circle.Visible = false

-- ============== ESP更新（缓存优化，无闪烁）==============

local function UpdateESP()
    -- 第一步：隐藏所有ESP对象
    for _, lines in pairs(ESPCache.Boxes) do
        for _, line in ipairs(lines) do if line then line.Visible = false end end
    end
    for _, lines in pairs(ESPCache.Skeletons) do
        for _, line in ipairs(lines) do if line then line.Visible = false end end
    end
    for _, label in pairs(ESPCache.Names) do if label then label.Visible = false end end
    for _, label in pairs(ESPCache.Tools) do if label then label.Visible = false end end

    if not ESPEnabled then return end

    -- 第二步：遍历玩家，更新并显示
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local char = p.Character
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                local teamColor = GetPlayerTeamColor(p)
                local isTeam = IsSameTeam(player, p)
                local boxColor = (TeamColorESPEnabled and isTeam) and teamColor or BoxColor
                local skelColor = (TeamColorESPEnabled and isTeam) and teamColor or SkeletonColor
                local nameColor = (TeamColorESPEnabled and isTeam) and teamColor or NameColor
                local toolColor = (TeamColorESPEnabled and isTeam) and teamColor or ToolColor

                -- 方框
                if BoxESPEnabled then
                    local boxes = ESPCache.Boxes[p]
                    if not boxes then
                        boxes = {}
                        for i=1,4 do
                            local line = Drawing.new("Line")
                            line.Thickness = 1
                            line.Color = boxColor
                            table.insert(boxes, line)
                        end
                        ESPCache.Boxes[p] = boxes
                    end
                    local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso")
                    if root then
                        local size = char:GetExtentsSize()
                        local cf = root.CFrame
                        local corners = {
                            cf * CFrame.new(size.X/2, size.Y/2, size.Z/2),
                            cf * CFrame.new(-size.X/2, size.Y/2, size.Z/2),
                            cf * CFrame.new(size.X/2, -size.Y/2, size.Z/2),
                            cf * CFrame.new(-size.X/2, -size.Y/2, size.Z/2),
                            cf * CFrame.new(size.X/2, size.Y/2, -size.Z/2),
                            cf * CFrame.new(-size.X/2, size.Y/2, -size.Z/2),
                            cf * CFrame.new(size.X/2, -size.Y/2, -size.Z/2),
                            cf * CFrame.new(-size.X/2, -size.Y/2, -size.Z/2)
                        }
                        local screenCorners = {}
                        local valid = true
                        for _, c in ipairs(corners) do
                            local sp = camera:WorldToViewportPoint(c.Position)
                            if sp.Z <= 0 then valid = false; break end
                            table.insert(screenCorners, Vector2.new(sp.X, sp.Y))
                        end
                        if valid and #screenCorners >= 4 then
                            local minX, minY = math.huge, math.huge
                            local maxX, maxY = -math.huge, -math.huge
                            for _, pos in ipairs(screenCorners) do
                                minX = math.min(minX, pos.X)
                                minY = math.min(minY, pos.Y)
                                maxX = math.max(maxX, pos.X)
                                maxY = math.max(maxY, pos.Y)
                            end
                            boxes[1].From = Vector2.new(minX, minY); boxes[1].To = Vector2.new(maxX, minY)
                            boxes[2].From = Vector2.new(minX, maxY); boxes[2].To = Vector2.new(maxX, maxY)
                            boxes[3].From = Vector2.new(minX, minY); boxes[3].To = Vector2.new(minX, maxY)
                            boxes[4].From = Vector2.new(maxX, minY); boxes[4].To = Vector2.new(maxX, maxY)
                            for _, line in ipairs(boxes) do
                                line.Color = boxColor
                                line.Visible = true
                            end
                        end
                    end
                end

                -- 骨骼
                if SkeletonESPEnabled then
                    local skels = ESPCache.Skeletons[p]
                    if not skels then
                        skels = {}
                        -- 预创建最多6条线（头-躯干、四肢）
                        for i=1,6 do
                            local line = Drawing.new("Line")
                            line.Thickness = 1
                            line.Color = skelColor
                            table.insert(skels, line)
                        end
                        ESPCache.Skeletons[p] = skels
                    end
                    -- 隐藏所有线，后面根据需要显示
                    for _, line in ipairs(skels) do line.Visible = false end

                    local bones = {
                        head = char:FindFirstChild("Head"),
                        torso = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso"),
                        leftArm = char:FindFirstChild("Left Arm") or char:FindFirstChild("LeftUpperArm") or char:FindFirstChild("LeftHand"),
                        rightArm = char:FindFirstChild("Right Arm") or char:FindFirstChild("RightUpperArm") or char:FindFirstChild("RightHand"),
                        leftLeg = char:FindFirstChild("Left Leg") or char:FindFirstChild("LeftLowerLeg") or char:FindFirstChild("LeftFoot"),
                        rightLeg = char:FindFirstChild("Right Leg") or char:FindFirstChild("RightLowerLeg") or char:FindFirstChild("RightFoot")
                    }

                    local idx = 1
                    if bones.head and bones.torso then
                        local h = camera:WorldToViewportPoint(bones.head.Position)
                        local t = camera:WorldToViewportPoint(bones.torso.Position)
                        if h.Z > 0 and t.Z > 0 then
                            skels[idx].From = Vector2.new(h.X, h.Y)
                            skels[idx].To = Vector2.new(t.X, t.Y)
                            skels[idx].Color = skelColor
                            skels[idx].Visible = true
                            idx = idx + 1
                        end
                    end
                    if bones.torso then
                        local t = camera:WorldToViewportPoint(bones.torso.Position)
                        if t.Z > 0 then
                            for _, limb in ipairs({bones.leftArm, bones.rightArm, bones.leftLeg, bones.rightLeg}) do
                                if limb and idx <= #skels then
                                    local l = camera:WorldToViewportPoint(limb.Position)
                                    if l.Z > 0 then
                                        skels[idx].From = Vector2.new(t.X, t.Y)
                                        skels[idx].To = Vector2.new(l.X, l.Y)
                                        skels[idx].Color = skelColor
                                        skels[idx].Visible = true
                                        idx = idx + 1
                                    end
                                end
                            end
                        end
                    end
                end

                -- 名字
                if NameESPEnabled then
                    local nameLabel = ESPCache.Names[p]
                    if not nameLabel then
                        nameLabel = Drawing.new("Text")
                        nameLabel.Size = 14
                        nameLabel.Center = true
                        nameLabel.Outline = true
                        nameLabel.OutlineColor = Color3.new(0,0,0)
                        ESPCache.Names[p] = nameLabel
                    end
                    local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso")
                    if root then
                        local pos = camera:WorldToViewportPoint(root.Position)
                        if pos.Z > 0 then
                            nameLabel.Position = Vector2.new(pos.X, pos.Y - 30)
                            nameLabel.Text = p.Name
                            nameLabel.Color = nameColor
                            nameLabel.Visible = true
                        end
                    end
                end

                -- 工具
                if ToolESPEnabled then
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool then
                        local toolLabel = ESPCache.Tools[p]
                        if not toolLabel then
                            toolLabel = Drawing.new("Text")
                            toolLabel.Size = 12
                            toolLabel.Center = true
                            toolLabel.Outline = true
                            toolLabel.OutlineColor = Color3.new(0,0,0)
                            ESPCache.Tools[p] = toolLabel
                        end
                        local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso")
                        if root then
                            local pos = camera:WorldToViewportPoint(root.Position)
                            if pos.Z > 0 then
                                toolLabel.Position = Vector2.new(pos.X, pos.Y - 50)
                                toolLabel.Text = "[" .. tool.Name .. "]"
                                toolLabel.Color = toolColor
                                toolLabel.Visible = true
                            end
                        end
                    end
                end
            end
        end
    end
end

-- ============== 主循环 ==============
RunService.RenderStepped:Connect(function()
    -- 自瞄
    if AimbotEnabled and IsHoldingMouse2 then
        if not LockedTarget then LockedTarget = GetClosestPlayer() end
        if LockedTarget and LockedTarget.Character and LockedTarget.Character:FindFirstChild("Head") then
            local hum = LockedTarget.Character:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                if not (AimbotIgnoreTeam and IsSameTeam(player, LockedTarget)) then
                    local pos = LockedTarget.Character.Head.Position
                    if PredictionEnabled then
                        pos = pos + LockedTarget.Character.Head.Velocity * (PredictionPing / 1000)
                    end
                    camera.CFrame = CFrame.new(camera.CFrame.Position, pos)
                else LockedTarget = nil end
            else LockedTarget = nil end
        end
    elseif not IsHoldingMouse2 then LockedTarget = nil end

    -- ESP（缓存优化，无闪烁）
    UpdateESP()

    -- FOV圆圈
    if AimbotEnabled and Circle then
        Circle.Visible = true
        Circle.Radius = FOV
        Circle.Position = UserInputService:GetMouseLocation()
    elseif Circle then Circle.Visible = false end
end)

-- 玩家离开时清理缓存
Players.PlayerRemoving:Connect(function(p)
    if ESPCache.Boxes[p] then
        for _, line in ipairs(ESPCache.Boxes[p]) do line:Destroy() end
        ESPCache.Boxes[p] = nil
    end
    if ESPCache.Skeletons[p] then
        for _, line in ipairs(ESPCache.Skeletons[p]) do line:Destroy() end
        ESPCache.Skeletons[p] = nil
    end
    if ESPCache.Names[p] then ESPCache.Names[p]:Destroy(); ESPCache.Names[p] = nil end
    if ESPCache.Tools[p] then ESPCache.Tools[p]:Destroy(); ESPCache.Tools[p] = nil end
end)

print("脚本加载成功！UI已显示，ESP无闪烁优化")
end) -- pcall结束

if not success then
    warn("脚本加载错误: " .. tostring(err))
else
    print("脚本成功加载！")
end
