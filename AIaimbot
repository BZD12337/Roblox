--懒得加密了，加密太贵，开源
local UIS = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- 自瞄变量
local AimbotEnabled = false
local IsHoldingMouse2 = false
local LockedTarget = nil
local FOV = 100

-- 预测变量
local PredictionEnabled = false
local PredictionPing = 0

-- ESP变量
local ESPEnabled = false
local BoxESPEnabled = true
local SkeletonESPEnabled = true
local NameESPEnabled = true
local ToolESPEnabled = true

-- ESP颜色设置
local BoxColor = Color3.fromRGB(255, 50, 50)
local SkeletonColor = Color3.fromRGB(255, 255, 255)
local NameColor = Color3.fromRGB(255, 255, 255)
local ToolColor = Color3.fromRGB(255, 255, 0)

-- 存储ESP对象
local ESPObjects = {}
local SkeletonLines = {}
local NameLabels = {}
local ToolLabels = {}

-- 创建主UI (简洁风格)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AimbotGUI"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = CoreGui

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 200, 0, 450)
Frame.Position = UDim2.new(0.5, -100, 0.5, -225)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

-- 圆角
local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 8)
FrameCorner.Parent = Frame

-- 标题栏
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = Frame

local TitleBarCorner = Instance.new("UICorner")
TitleBarCorner.CornerRadius = UDim.new(0, 8)
TitleBarCorner.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Size = UDim2.new(1, -35, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "自瞄+ESP"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextSize = 14
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Font = Enum.Font.SourceSansBold
TitleText.Parent = TitleBar

-- 关闭按钮
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -30, 0, 2.5)
CloseButton.Text = "X"
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.BorderSizePixel = 0
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 16
CloseButton.Parent = TitleBar

local CloseButtonCorner = Instance.new("UICorner")
CloseButtonCorner.CornerRadius = UDim.new(0, 6)
CloseButtonCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    -- 清理ESP
    for _, data in pairs(ESPObjects) do
        if data.Highlight then data.Highlight:Destroy() end
    end
    for _, line in pairs(SkeletonLines) do
        if line then line:Destroy() end
    end
    for _, label in pairs(NameLabels) do
        if label then label:Destroy() end
    end
    for _, label in pairs(ToolLabels) do
        if label then label:Destroy() end
    end
end)

-- 最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -60, 0, 2.5)
MinimizeButton.Text = "–"
MinimizeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.BorderSizePixel = 0
MinimizeButton.Font = Enum.Font.SourceSansBold
MinimizeButton.TextSize = 20
MinimizeButton.Parent = TitleBar

local MinimizeButtonCorner = Instance.new("UICorner")
MinimizeButtonCorner.CornerRadius = UDim.new(0, 6)
MinimizeButtonCorner.Parent = MinimizeButton

-- 最小化后的按钮
local MinimizedButton = Instance.new("TextButton")
MinimizedButton.Size = UDim2.new(0, 40, 0, 40)
MinimizedButton.Position = UDim2.new(0, 10, 0, 10)
MinimizedButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MinimizedButton.BorderSizePixel = 0
MinimizedButton.Text = "A+E"
MinimizedButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizedButton.TextSize = 12
MinimizedButton.Font = Enum.Font.SourceSansBold
MinimizedButton.Visible = false
MinimizedButton.Parent = ScreenGui

local MinimizedButtonCorner = Instance.new("UICorner")
MinimizedButtonCorner.CornerRadius = UDim.new(0, 20)
MinimizedButtonCorner.Parent = MinimizedButton

-- 内容滚动框
local ScrollingFrame = Instance.new("ScrollingFrame")
ScrollingFrame.Size = UDim2.new(1, 0, 1, -35)
ScrollingFrame.Position = UDim2.new(0, 0, 0, 35)
ScrollingFrame.BackgroundTransparency = 1
ScrollingFrame.BorderSizePixel = 0
ScrollingFrame.ScrollBarThickness = 3
ScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 700)
ScrollingFrame.Parent = Frame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 5)
UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIListLayout.Parent = ScrollingFrame

-- 自瞄开关按钮
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0.9, 0, 0, 35)
ToggleButton.Position = UDim2.new(0.05, 0, 0, 5)
ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ToggleButton.Text = "开启自瞄"
ToggleButton.Font = Enum.Font.SourceSans
ToggleButton.TextColor3 = Color3.new(1, 1, 1)
ToggleButton.TextSize = 16
ToggleButton.Parent = ScrollingFrame

local ToggleButtonCorner = Instance.new("UICorner")
ToggleButtonCorner.CornerRadius = UDim.new(0, 6)
ToggleButtonCorner.Parent = ToggleButton

-- 状态标签
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0, 25)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "状态: OFF"
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.TextSize = 14
StatusLabel.Parent = ScrollingFrame

-- FOV控制
local FOVLabel = Instance.new("TextLabel")
FOVLabel.Size = UDim2.new(0.9, 0, 0, 20)
FOVLabel.BackgroundTransparency = 1
FOVLabel.Text = "FOV范围: 100"
FOVLabel.Font = Enum.Font.SourceSans
FOVLabel.TextColor3 = Color3.new(1, 1, 1)
FOVLabel.TextSize = 14
FOVLabel.TextXAlignment = Enum.TextXAlignment.Left
FOVLabel.Parent = ScrollingFrame

local FOVSlider = Instance.new("Frame")
FOVSlider.Size = UDim2.new(0.9, 0, 0, 15)
FOVSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
FOVSlider.BorderSizePixel = 0
FOVSlider.Parent = ScrollingFrame

local FOVSliderCorner = Instance.new("UICorner")
FOVSliderCorner.CornerRadius = UDim.new(0, 7)
FOVSliderCorner.Parent = FOVSlider

local FOVSliderFill = Instance.new("Frame")
FOVSliderFill.Size = UDim2.new(0.33, 0, 1, 0)
FOVSliderFill.BackgroundColor3 = Color3.fromRGB(80, 160, 255)
FOVSliderFill.BorderSizePixel = 0
FOVSliderFill.Parent = FOVSlider

local FOVSliderFillCorner = Instance.new("UICorner")
FOVSliderFillCorner.CornerRadius = UDim.new(0, 7)
FOVSliderFillCorner.Parent = FOVSliderFill

local FOVSliderButton = Instance.new("TextButton")
FOVSliderButton.Size = UDim2.new(1, 0, 1, 0)
FOVSliderButton.BackgroundTransparency = 1
FOVSliderButton.Text = ""
FOVSliderButton.Parent = FOVSlider

-- 预测标题
local PredictionTitle = Instance.new("TextLabel")
PredictionTitle.Size = UDim2.new(0.9, 0, 0, 20)
PredictionTitle.BackgroundTransparency = 1
PredictionTitle.Text = "预测延迟"
PredictionTitle.Font = Enum.Font.SourceSans
PredictionTitle.TextColor3 = Color3.new(1, 1, 1)
PredictionTitle.TextSize = 14
PredictionTitle.TextXAlignment = Enum.TextXAlignment.Left
PredictionTitle.Parent = ScrollingFrame

-- 预测按钮容器
local PredictionContainer = Instance.new("Frame")
PredictionContainer.Size = UDim2.new(0.9, 0, 0, 35)
PredictionContainer.BackgroundTransparency = 1
PredictionContainer.Parent = ScrollingFrame

local Prediction100Button = Instance.new("TextButton")
Prediction100Button.Size = UDim2.new(0.3, -3, 1, 0)
Prediction100Button.Position = UDim2.new(0, 0, 0, 0)
Prediction100Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Prediction100Button.Text = "100ms OFF"
Prediction100Button.Font = Enum.Font.SourceSans
Prediction100Button.TextColor3 = Color3.new(1, 1, 1)
Prediction100Button.TextSize = 13
Prediction100Button.Parent = PredictionContainer

local Prediction100Corner = Instance.new("UICorner")
Prediction100Corner.CornerRadius = UDim.new(0, 6)
Prediction100Corner.Parent = Prediction100Button

local Prediction150Button = Instance.new("TextButton")
Prediction150Button.Size = UDim2.new(0.3, -3, 1, 0)
Prediction150Button.Position = UDim2.new(0.35, 0, 0, 0)
Prediction150Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Prediction150Button.Text = "150ms OFF"
Prediction150Button.Font = Enum.Font.SourceSans
Prediction150Button.TextColor3 = Color3.new(1, 1, 1)
Prediction150Button.TextSize = 13
Prediction150Button.Parent = PredictionContainer

local Prediction150Corner = Instance.new("UICorner")
Prediction150Corner.CornerRadius = UDim.new(0, 6)
Prediction150Corner.Parent = Prediction150Button

local Prediction200Button = Instance.new("TextButton")
Prediction200Button.Size = UDim2.new(0.3, -3, 1, 0)
Prediction200Button.Position = UDim2.new(0.7, 0, 0, 0)
Prediction200Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Prediction200Button.Text = "200ms OFF"
Prediction200Button.Font = Enum.Font.SourceSans
Prediction200Button.TextColor3 = Color3.new(1, 1, 1)
Prediction200Button.TextSize = 13
Prediction200Button.Parent = PredictionContainer

local Prediction200Corner = Instance.new("UICorner")
Prediction200Corner.CornerRadius = UDim.new(0, 6)
Prediction200Corner.Parent = Prediction200Button

-- ESP标题和开关
local ESPTitle = Instance.new("TextLabel")
ESPTitle.Size = UDim2.new(0.9, 0, 0, 25)
ESPTitle.BackgroundTransparency = 1
ESPTitle.Text = "ESP设置"
ESPTitle.Font = Enum.Font.SourceSansBold
ESPTitle.TextColor3 = Color3.fromRGB(100, 200, 255)
ESPTitle.TextSize = 16
ESPTitle.TextXAlignment = Enum.TextXAlignment.Left
ESPTitle.Parent = ScrollingFrame

-- 总ESP开关
local ESPToggleButton = Instance.new("TextButton")
ESPToggleButton.Size = UDim2.new(0.9, 0, 0, 35)
ESPToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ESPToggleButton.Text = "开启ESP"
ESPToggleButton.Font = Enum.Font.SourceSans
ESPToggleButton.TextColor3 = Color3.new(1, 1, 1)
ESPToggleButton.TextSize = 15
ESPToggleButton.Parent = ScrollingFrame

local ESPToggleButtonCorner = Instance.new("UICorner")
ESPToggleButtonCorner.CornerRadius = UDim.new(0, 6)
ESPToggleButtonCorner.Parent = ESPToggleButton

-- ESP选项开关
local BoxESPToggle = Instance.new("TextButton")
BoxESPToggle.Size = UDim2.new(0.9, 0, 0, 30)
BoxESPToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
BoxESPToggle.Text = "玩家方框: ON"
BoxESPToggle.Font = Enum.Font.SourceSans
BoxESPToggle.TextColor3 = Color3.new(1, 1, 1)
BoxESPToggle.TextSize = 14
BoxESPToggle.Parent = ScrollingFrame

local BoxESPCorner = Instance.new("UICorner")
BoxESPCorner.CornerRadius = UDim.new(0, 6)
BoxESPCorner.Parent = BoxESPToggle

-- 方框颜色选择
local BoxColorButton = Instance.new("TextButton")
BoxColorButton.Size = UDim2.new(0.9, 0, 0, 25)
BoxColorButton.BackgroundColor3 = BoxColor
BoxColorButton.Text = "方框颜色"
BoxColorButton.Font = Enum.Font.SourceSans
BoxColorButton.TextColor3 = Color3.new(1, 1, 1)
BoxColorButton.TextSize = 13
BoxColorButton.Parent = ScrollingFrame

local BoxColorCorner = Instance.new("UICorner")
BoxColorCorner.CornerRadius = UDim.new(0, 6)
BoxColorCorner.Parent = BoxColorButton

local SkeletonESPToggle = Instance.new("TextButton")
SkeletonESPToggle.Size = UDim2.new(0.9, 0, 0, 30)
SkeletonESPToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
SkeletonESPToggle.Text = "玩家骨骼: ON"
SkeletonESPToggle.Font = Enum.Font.SourceSans
SkeletonESPToggle.TextColor3 = Color3.new(1, 1, 1)
SkeletonESPToggle.TextSize = 14
SkeletonESPToggle.Parent = ScrollingFrame

local SkeletonESPCorner = Instance.new("UICorner")
SkeletonESPCorner.CornerRadius = UDim.new(0, 6)
SkeletonESPCorner.Parent = SkeletonESPToggle

-- 骨骼颜色选择
local SkeletonColorButton = Instance.new("TextButton")
SkeletonColorButton.Size = UDim2.new(0.9, 0, 0, 25)
SkeletonColorButton.BackgroundColor3 = SkeletonColor
SkeletonColorButton.Text = "骨骼颜色"
SkeletonColorButton.Font = Enum.Font.SourceSans
SkeletonColorButton.TextColor3 = Color3.new(0, 0, 0)
SkeletonColorButton.TextSize = 13
SkeletonColorButton.Parent = ScrollingFrame

local SkeletonColorCorner = Instance.new("UICorner")
SkeletonColorCorner.CornerRadius = UDim.new(0, 6)
SkeletonColorCorner.Parent = SkeletonColorButton

local NameESPToggle = Instance.new("TextButton")
NameESPToggle.Size = UDim2.new(0.9, 0, 0, 30)
NameESPToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
NameESPToggle.Text = "玩家名字: ON"
NameESPToggle.Font = Enum.Font.SourceSans
NameESPToggle.TextColor3 = Color3.new(1, 1, 1)
NameESPToggle.TextSize = 14
NameESPToggle.Parent = ScrollingFrame

local NameESPCorner = Instance.new("UICorner")
NameESPCorner.CornerRadius = UDim.new(0, 6)
NameESPCorner.Parent = NameESPToggle

-- 名字颜色选择
local NameColorButton = Instance.new("TextButton")
NameColorButton.Size = UDim2.new(0.9, 0, 0, 25)
NameColorButton.BackgroundColor3 = NameColor
NameColorButton.Text = "名字颜色"
NameColorButton.Font = Enum.Font.SourceSans
NameColorButton.TextColor3 = Color3.new(0, 0, 0)
NameColorButton.TextSize = 13
NameColorButton.Parent = ScrollingFrame

local NameColorCorner = Instance.new("UICorner")
NameColorCorner.CornerRadius = UDim.new(0, 6)
NameColorCorner.Parent = NameColorButton

local ToolESPToggle = Instance.new("TextButton")
ToolESPToggle.Size = UDim2.new(0.9, 0, 0, 30)
ToolESPToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ToolESPToggle.Text = "手持物品: ON"
ToolESPToggle.Font = Enum.Font.SourceSans
ToolESPToggle.TextColor3 = Color3.new(1, 1, 1)
ToolESPToggle.TextSize = 14
ToolESPToggle.Parent = ScrollingFrame

local ToolESPCorner = Instance.new("UICorner")
ToolESPCorner.CornerRadius = UDim.new(0, 6)
ToolESPCorner.Parent = ToolESPToggle

-- 物品颜色选择
local ToolColorButton = Instance.new("TextButton")
ToolColorButton.Size = UDim2.new(0.9, 0, 0, 25)
ToolColorButton.BackgroundColor3 = ToolColor
ToolColorButton.Text = "物品颜色"
ToolColorButton.Font = Enum.Font.SourceSans
ToolColorButton.TextColor3 = Color3.new(0, 0, 0)
ToolColorButton.TextSize = 13
ToolColorButton.Parent = ScrollingFrame

local ToolColorCorner = Instance.new("UICorner")
ToolColorCorner.CornerRadius = UDim.new(0, 6)
ToolColorCorner.Parent = ToolColorButton

-- 重置位置按钮
local ResetPositionButton = Instance.new("TextButton")
ResetPositionButton.Size = UDim2.new(0.9, 0, 0, 30)
ResetPositionButton.BackgroundColor3 = Color3.fromRGB(80, 80, 90)
ResetPositionButton.Text = "重置UI位置"
ResetPositionButton.Font = Enum.Font.SourceSans
ResetPositionButton.TextColor3 = Color3.new(1, 1, 1)
ResetPositionButton.TextSize = 14
ResetPositionButton.Parent = ScrollingFrame

local ResetPositionCorner = Instance.new("UICorner")
ResetPositionCorner.CornerRadius = UDim.new(0, 6)
ResetPositionCorner.Parent = ResetPositionButton

-- 设置CanvasSize
local function UpdateCanvasSize()
    local count = #ScrollingFrame:GetChildren()
    ScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, count * 42 + 100)
end

-- 自瞄开关函数
local function ToggleAimbot()
    AimbotEnabled = not AimbotEnabled
    ToggleButton.Text = AimbotEnabled and "关闭自瞄" or "开启自瞄"
    ToggleButton.BackgroundColor3 = AimbotEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(60, 60, 60)
    StatusLabel.Text = "状态: " .. (AimbotEnabled and "ON" or "OFF")
    if not AimbotEnabled then LockedTarget = nil end
end

ToggleButton.MouseButton1Click:Connect(ToggleAimbot)

-- 预测按钮功能
local function SetupPredictionButton(button, ping)
    button.MouseButton1Click:Connect(function()
        if PredictionPing == ping then
            PredictionEnabled = not PredictionEnabled
        else
            PredictionPing = ping
            PredictionEnabled = true
        end
        
        -- 重置所有按钮颜色和文本
        Prediction100Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        Prediction150Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        Prediction200Button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        Prediction100Button.Text = "100ms OFF"
        Prediction150Button.Text = "150ms OFF"
        Prediction200Button.Text = "200ms OFF"
        
        -- 更新当前按钮
        if PredictionEnabled then
            button.BackgroundColor3 = Color3.fromRGB(80, 160, 255)
            button.Text = ping .. "ms ON"
        end
    end)
end

SetupPredictionButton(Prediction100Button, 100)
SetupPredictionButton(Prediction150Button, 150)
SetupPredictionButton(Prediction200Button, 200)

-- FOV滑块控制
FOVSliderButton.MouseButton1Down:Connect(function()
    local connection
    connection = UIS.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = UIS:GetMouseLocation()
            local sliderPos = FOVSlider.AbsolutePosition.X
            local sliderSize = FOVSlider.AbsoluteSize.X
            
            local x = math.clamp(mousePos.X - sliderPos, 0, sliderSize)
            local ratio = x / sliderSize
            FOV = math.floor(ratio * 300)
            FOVSliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            FOVLabel.Text = "FOV范围: " .. FOV
        end
    end)
    
    local endConnection
    endConnection = UIS.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            connection:Disconnect()
            endConnection:Disconnect()
        end
    end)
end)

-- 颜色选择函数
local function CreateColorPicker(title, defaultColor, callback)
    local colors = {
        Color3.fromRGB(255, 50, 50),   -- 红色
        Color3.fromRGB(50, 255, 50),   -- 绿色
        Color3.fromRGB(50, 50, 255),   -- 蓝色
        Color3.fromRGB(255, 255, 50),  -- 黄色
        Color3.fromRGB(255, 50, 255),  -- 紫色
        Color3.fromRGB(50, 255, 255),  -- 青色
        Color3.fromRGB(255, 255, 255), -- 白色
        Color3.fromRGB(0, 0, 0)        -- 黑色
    }
    
    local colorNames = {"红", "绿", "蓝", "黄", "紫", "青", "白", "黑"}
    
    local colorPicker = Instance.new("Frame")
    colorPicker.Size = UDim2.new(0.9, 0, 0, 40)
    colorPicker.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    colorPicker.BorderSizePixel = 0
    colorPicker.Parent = ScrollingFrame
    
    local colorPickerCorner = Instance.new("UICorner")
    colorPickerCorner.CornerRadius = UDim.new(0, 6)
    colorPickerCorner.Parent = colorPicker
    
    local colorPickerTitle = Instance.new("TextLabel")
    colorPickerTitle.Size = UDim2.new(0.3, 0, 1, 0)
    colorPickerTitle.Position = UDim2.new(0, 5, 0, 0)
    colorPickerTitle.BackgroundTransparency = 1
    colorPickerTitle.Text = title
    colorPickerTitle.Font = Enum.Font.SourceSans
    colorPickerTitle.TextColor3 = Color3.new(1, 1, 1)
    colorPickerTitle.TextSize = 13
    colorPickerTitle.TextXAlignment = Enum.TextXAlignment.Left
    colorPickerTitle.Parent = colorPicker
    
    for i = 1, 8 do
        local colorButton = Instance.new("TextButton")
        colorButton.Size = UDim2.new(0, 20, 0, 20)
        colorButton.Position = UDim2.new(0.3 + (i-1) * 0.07, 0, 0.5, -10)
        colorButton.BackgroundColor3 = colors[i]
        colorButton.BorderSizePixel = 0
        colorButton.Text = ""
        colorButton.Parent = colorPicker
        
        local colorButtonCorner = Instance.new("UICorner")
        colorButtonCorner.CornerRadius = UDim.new(0, 4)
        colorButtonCorner.Parent = colorButton
        
        colorButton.MouseButton1Click:Connect(function()
            callback(colors[i])
            colorPicker:Destroy()
        end)
    end
    
    UpdateCanvasSize()
end

-- 颜色按钮事件
BoxColorButton.MouseButton1Click:Connect(function()
    CreateColorPicker("方框颜色", BoxColor, function(color)
        BoxColor = color
        BoxColorButton.BackgroundColor3 = color
        -- 更新所有ESP方框颜色
        for _, data in pairs(ESPObjects) do
            if data.Highlight then
                data.Highlight.OutlineColor = color
            end
        end
    end)
end)

SkeletonColorButton.MouseButton1Click:Connect(function()
    CreateColorPicker("骨骼颜色", SkeletonColor, function(color)
        SkeletonColor = color
        SkeletonColorButton.BackgroundColor3 = color
        SkeletonColorButton.TextColor3 = (color.R + color.G + color.B) > 1.5 and Color3.new(0,0,0) or Color3.new(1,1,1)
    end)
end)

NameColorButton.MouseButton1Click:Connect(function()
    CreateColorPicker("名字颜色", NameColor, function(color)
        NameColor = color
        NameColorButton.BackgroundColor3 = color
        NameColorButton.TextColor3 = (color.R + color.G + color.B) > 1.5 and Color3.new(0,0,0) or Color3.new(1,1,1)
    end)
end)

ToolColorButton.MouseButton1Click:Connect(function()
    CreateColorPicker("物品颜色", ToolColor, function(color)
        ToolColor = color
        ToolColorButton.BackgroundColor3 = color
        ToolColorButton.TextColor3 = (color.R + color.G + color.B) > 1.5 and Color3.new(0,0,0) or Color3.new(1,1,1)
    end)
end)

-- ESP开关函数
local function ToggleESP()
    ESPEnabled = not ESPEnabled
    ESPToggleButton.Text = ESPEnabled and "关闭ESP" or "开启ESP"
    ESPToggleButton.BackgroundColor3 = ESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(60, 60, 60)
    
    if not ESPEnabled then
        -- 清理所有ESP
        for _, data in pairs(ESPObjects) do
            if data.Highlight then data.Highlight:Destroy() end
        end
        for _, line in pairs(SkeletonLines) do
            if line then line:Destroy() end
        end
        for _, label in pairs(NameLabels) do
            if label then label:Destroy() end
        end
        for _, label in pairs(ToolLabels) do
            if label then label:Destroy() end
        end
        ESPObjects = {}
        SkeletonLines = {}
        NameLabels = {}
        ToolLabels = {}
    end
end

ESPToggleButton.MouseButton1Click:Connect(ToggleESP)

-- ESP子选项开关
BoxESPToggle.MouseButton1Click:Connect(function()
    BoxESPEnabled = not BoxESPEnabled
    BoxESPToggle.Text = "玩家方框: " .. (BoxESPEnabled and "ON" or "OFF")
    BoxESPToggle.BackgroundColor3 = BoxESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(50, 50, 55)
    
    if ESPEnabled then
        for _, data in pairs(ESPObjects) do
            if data.Highlight then
                if BoxESPEnabled then
                    data.Highlight.OutlineColor = BoxColor
                    data.Highlight.OutlineTransparency = 0.2
                    data.Highlight.FillTransparency = 1
                else
                    data.Highlight.OutlineTransparency = 1
                end
            end
        end
    end
end)

SkeletonESPToggle.MouseButton1Click:Connect(function()
    SkeletonESPEnabled = not SkeletonESPEnabled
    SkeletonESPToggle.Text = "玩家骨骼: " .. (SkeletonESPEnabled and "ON" or "OFF")
    SkeletonESPToggle.BackgroundColor3 = SkeletonESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(50, 50, 55)
end)

NameESPToggle.MouseButton1Click:Connect(function()
    NameESPEnabled = not NameESPEnabled
    NameESPToggle.Text = "玩家名字: " .. (NameESPEnabled and "ON" or "OFF")
    NameESPToggle.BackgroundColor3 = NameESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(50, 50, 55)
end)

ToolESPToggle.MouseButton1Click:Connect(function()
    ToolESPEnabled = not ToolESPEnabled
    ToolESPToggle.Text = "手持物品: " .. (ToolESPEnabled and "ON" or "OFF")
    ToolESPToggle.BackgroundColor3 = ToolESPEnabled and Color3.fromRGB(60, 180, 80) or Color3.fromRGB(50, 50, 55)
end)

-- 重置UI位置
local function ResetUIPosition()
    Frame.Position = UDim2.new(0.5, -100, 0.5, -225)
    MinimizedButton.Position = UDim2.new(0, 10, 0, 10)
end

ResetPositionButton.MouseButton1Click:Connect(ResetUIPosition)

-- 最小化动画
local isAnimating = false
local function createOpenAnimation()
    if isAnimating then return end
    isAnimating = true
    
    Frame.Visible = true
    MinimizedButton.Visible = false
    
    local originalSize = UDim2.new(0, 200, 0, 450)
    local originalPosition = UDim2.new(0.5, -100, 0.5, -225)
    
    local buttonPos = MinimizedButton.AbsolutePosition
    local buttonSize = MinimizedButton.AbsoluteSize
    
    local startSize = UDim2.new(0, buttonSize.X, 0, buttonSize.Y)
    local startPos = UDim2.new(0, buttonPos.X, 0, buttonPos.Y)
    
    Frame.Size = startSize
    Frame.Position = startPos
    
    local sizeTween = TweenService:Create(
        Frame,
        TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
        {Size = originalSize}
    )
    
    local positionTween = TweenService:Create(
        Frame,
        TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
        {Position = originalPosition}
    )
    
    sizeTween:Play()
    positionTween:Play()
    
    delay(0.3, function()
        isAnimating = false
    end)
end

local function createCloseAnimation()
    if isAnimating then return end
    isAnimating = true
    
    local targetSize = MinimizedButton.Size
    local targetPos = MinimizedButton.Position
    
    local sizeTween = TweenService:Create(
        Frame,
        TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In),
        {Size = targetSize}
    )
    
    local positionTween = TweenService:Create(
        Frame,
        TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In),
        {Position = targetPos}
    )
    
    sizeTween:Play()
    positionTween:Play()
    
    delay(0.25, function()
        Frame.Visible = false
        MinimizedButton.Visible = true
        isAnimating = false
    end)
end

MinimizeButton.MouseButton1Click:Connect(createCloseAnimation)
MinimizedButton.MouseButton1Click:Connect(createOpenAnimation)

-- 悬浮窗拖动
local dragging = false
local dragStart, startPos

MinimizedButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MinimizedButton.Position
    end
end)

MinimizedButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        local newX = math.clamp(startPos.X.Offset + delta.X, 0, ScreenGui.AbsoluteSize.X - MinimizedButton.AbsoluteSize.X)
        local newY = math.clamp(startPos.Y.Offset + delta.Y, 0, ScreenGui.AbsoluteSize.Y - MinimizedButton.AbsoluteSize.Y)
        MinimizedButton.Position = UDim2.new(0, newX, 0, newY)
    end
end)

-- 自瞄功能
UIS.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 and AimbotEnabled then
        IsHoldingMouse2 = true
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        IsHoldingMouse2 = false
        LockedTarget = nil
        StatusLabel.Text = "状态: " .. (AimbotEnabled and "ON" or "OFF")
    end
end)

local function GetClosestPlayer()
    local closestPlayer, shortestDistance = nil, FOV
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local targetPos = player.Character.Head.Position
            local screenPoint = Camera:WorldToViewportPoint(targetPos)
            if screenPoint.Z > 0 then
                local mousePos = UIS:GetMouseLocation()
                local distance = (Vector2.new(mousePos.X, mousePos.Y) - Vector2.new(screenPoint.X, screenPoint.Y)).Magnitude
                if distance < shortestDistance then
                    closestPlayer, shortestDistance = player, distance
                end
            end
        end
    end
    return closestPlayer
end

-- 自瞄主循环
RunService.RenderStepped:Connect(function()
    if AimbotEnabled and IsHoldingMouse2 then
        if not LockedTarget then 
            LockedTarget = GetClosestPlayer()
            StatusLabel.Text = "状态: ON | 锁定: " .. (LockedTarget and LockedTarget.Name or "无")
        end
        if LockedTarget and LockedTarget.Character and LockedTarget.Character:FindFirstChild("Head") then
            local targetPos = LockedTarget.Character.Head.Position
            if PredictionEnabled then
                local velocity = LockedTarget.Character.Head.Velocity
                targetPos += velocity * (PredictionPing / 1000)
            end
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPos)
        end
    end
end)

-- FOV圆圈
local Circle = Drawing.new("Circle")
Circle.Color = Color3.fromRGB(0, 255, 0)
Circle.Thickness = 2
Circle.Filled = false
Circle.NumSides = 64
Circle.Transparency = 0.7
Circle.Visible = false

RunService.RenderStepped:Connect(function()
    if AimbotEnabled then
        Circle.Visible = true
        Circle.Radius = FOV
        Circle.Position = UIS:GetMouseLocation()
    else
        Circle.Visible = false
    end
end)

-- ESP功能
local function GetBonePosition(character, boneName)
    if not character then return nil end
    local part = character:FindFirstChild(boneName)
    if part then
        return part.Position
    end
    return nil
end

local function DrawSkeleton(character, color)
    if not character then return end
    
    local head = character:FindFirstChild("Head")
    local torso = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    local leftShoulder = character:FindFirstChild("LeftShoulder") or character:FindFirstChild("Left Arm") or character:FindFirstChild("LeftUpperArm")
    local rightShoulder = character:FindFirstChild("RightShoulder") or character:FindFirstChild("Right Arm") or character:FindFirstChild("RightUpperArm")
    local leftHip = character:FindFirstChild("LeftHip") or character:FindFirstChild("Left Leg") or character:FindFirstChild("LeftLowerLeg")
    local rightHip = character:FindFirstChild("RightHip") or character:FindFirstChild("Right Leg") or character:FindFirstChild("RightLowerLeg")
    
    local connections = {}
    
    if head and torso then
        table.insert(connections, {head.Position, torso.Position})
    end
    if leftShoulder and torso then
        local leftHand = character:FindFirstChild("LeftHand") or character:FindFirstChild("Left Arm") or character:FindFirstChild("LeftLowerArm")
        if leftHand then
            table.insert(connections, {leftShoulder.Position, leftHand.Position})
        end
        table.insert(connections, {torso.Position, leftShoulder.Position})
    end
    if rightShoulder and torso then
        local rightHand = character:FindFirstChild("RightHand") or character:FindFirstChild("Right Arm") or character:FindFirstChild("RightLowerArm")
        if rightHand then
            table.insert(connections, {rightShoulder.Position, rightHand.Position})
        end
        table.insert(connections, {torso.Position, rightShoulder.Position})
    end
    if leftHip and torso then
        local leftFoot = character:FindFirstChild("LeftFoot") or character:FindFirstChild("Left Leg") or character:FindFirstChild("LeftLowerLeg")
        if leftFoot then
            table.insert(connections, {leftHip.Position, leftFoot.Position})
        end
        table.insert(connections, {torso.Position, leftHip.Position})
    end
    if rightHip and torso then
        local rightFoot = character:FindFirstChild("RightFoot") or character:FindFirstChild("Right Leg") or character:FindFirstChild("RightLowerLeg")
        if rightFoot then
            table.insert(connections, {rightHip.Position, rightFoot.Position})
        end
        table.insert(connections, {torso.Position, rightHip.Position})
    end
    
    return connections
end

local function CreateDrawingLine(pos1, pos2, color)
    local screenPos1 = Camera:WorldToViewportPoint(pos1)
    local screenPos2 = Camera:WorldToViewportPoint(pos2)
    
    if screenPos1.Z > 0 and screenPos2.Z > 0 then
        local line = Drawing.new("Line")
        line.From = Vector2.new(screenPos1.X, screenPos1.Y)
        line.To = Vector2.new(screenPos2.X, screenPos2.Y)
        line.Color = color
        line.Thickness = 1
        line.Transparency = 0.5
        line.Visible = true
        return line
    end
    return nil
end

local function CreateNameLabel(player, position, color)
    local label = Drawing.new("Text")
    label.Text = player.Name
    label.Color = color
    label.Size = 16
    label.Center = true
    label.Outline = true
    label.OutlineColor = Color3.new(0, 0, 0)
    label.Position = Vector2.new(position.X, position.Y - 20)
    label.Visible = true
    return label
end

local function CreateToolLabel(tool, position, color)
    local label = Drawing.new("Text")
    label.Text = "[" .. tool.Name .. "]"
    label.Color = color
    label.Size = 14
    label.Center = true
    label.Outline = true
    label.OutlineColor = Color3.new(0, 0, 0)
    label.Position = Vector2.new(position.X, position.Y - 40)
    label.Visible = true
    return label
end

-- ESP更新循环
RunService.RenderStepped:Connect(function()
    if not ESPEnabled then return end
    
    -- 清理旧的Drawing对象
    for _, line in pairs(SkeletonLines) do
        if line then line:Destroy() end
    end
    for _, label in pairs(NameLabels) do
        if label then label:Destroy() end
    end
    for _, label in pairs(ToolLabels) do
        if label then label:Destroy() end
    end
    
    SkeletonLines = {}
    NameLabels = {}
    ToolLabels = {}
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and humanoid.Health > 0 and rootPart then
                -- 玩家方框ESP (使用Highlight)
                if BoxESPEnabled then
                    if not ESPObjects[player] then
                        ESPObjects[player] = {}
                    end
                    
                    if not ESPObjects[player].Highlight and character then
                        local highlight = Instance.new("Highlight")
                        highlight.Adornee = character
                        highlight.FillColor = BoxColor
                        highlight.FillTransparency = 1
                        highlight.OutlineColor = BoxColor
                        highlight.OutlineTransparency = 0.2
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                        highlight.Parent = character
                        ESPObjects[player].Highlight = highlight
                    end
                else
                    if ESPObjects[player] and ESPObjects[player].Highlight then
                        ESPObjects[player].Highlight:Destroy()
                        ESPObjects[player].Highlight = nil
                    end
                end
                
                local screenPos = Camera:WorldToViewportPoint(rootPart.Position)
                if screenPos.Z > 0 then
                    -- 骨骼ESP
                    if SkeletonESPEnabled then
                        local connections = DrawSkeleton(character, SkeletonColor)
                        for _, conn in ipairs(connections) do
                            local line = CreateDrawingLine(conn[1], conn[2], SkeletonColor)
                            if line then
                                table.insert(SkeletonLines, line)
                            end
                        end
                    end
                    
                    -- 名字ESP
                    if NameESPEnabled then
                        local nameLabel = CreateNameLabel(player, Vector2.new(screenPos.X, screenPos.Y - 30), NameColor)
                        if nameLabel then
                            table.insert(NameLabels, nameLabel)
                        end
                    end
                    
                    -- 手持物品ESP
                    if ToolESPEnabled then
                        local tool = character:FindFirstChildOfClass("Tool")
                        if tool then
                            local toolLabel = CreateToolLabel(tool, Vector2.new(screenPos.X, screenPos.Y - 50), ToolColor)
                            if toolLabel then
                                table.insert(ToolLabels, toolLabel)
                            end
                        end
                    end
                end
            end
        end
    end
end)

-- 玩家加入时自动添加ESP
Players.PlayerAdded:Connect(function(player)
    if ESPEnabled and BoxESPEnabled then
        player.CharacterAdded:Connect(function(character)
            wait(0.5)
            if ESPEnabled and BoxESPEnabled and character then
                local highlight = Instance.new("Highlight")
                highlight.Adornee = character
                highlight.FillColor = BoxColor
                highlight.FillTransparency = 1
                highlight.OutlineColor = BoxColor
                highlight.OutlineTransparency = 0.2
                highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                highlight.Parent = character
                
                if not ESPObjects[player] then
                    ESPObjects[player] = {}
                end
                ESPObjects[player].Highlight = highlight
            end
        end)
    end
end)

-- 玩家离开时清理ESP
Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        if ESPObjects[player].Highlight then
            ESPObjects[player].Highlight:Destroy()
        end
        ESPObjects[player] = nil
    end
end)

-- 初始化
UpdateCanvasSize()
